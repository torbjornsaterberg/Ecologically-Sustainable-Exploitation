
######################################################################
# Fit a MAR(1)-model with covariates and return fitted model         #
######################################################################
# This script is used to fit MAR(1)-models with exploitation rates 
# and environmental covariates. It uses cls to find the most parsimonious model
# out of all possible models that are given by the input matrix Restrictions.
#
# MAR(1)-model with fishing mortality and environmental covariates
# X(t)=A+BX(t-1)+CU(t)+DF(t)+E(t)
# E(t)~MVN(0,R)
#
# INPUT: DAT - A list containing time series data:
#                          X - log(fish abundance)
#                          F - Standardized fishing mortality
#                          U - Standardized environmental covariates
#
#        Restrictions - A restriction matrix with codes:0,0.5 and 1
#                          0 - dont include in model
#                          0.5 - maybe include in model
#                          1 - include in model
#
#                       Restrictions = (res_B res_F res_U); 
#                       dim(Restrictions)=(nb of sp) x (nb_of_sp + nb_of_fishing_ts + nb_of_covariate_ts)
# 
# OUTPUT: param - A list containing estimated parameters and input time series
#                   B - Per log-abundance interactions effect of species j on 
#                       species i's per capita growth rate
#                   C - The per unit covariate(U) effects on species' per capita 
#                       growth rates 
#                   D - The per unit fishing mortality(F) effects on species' per
#                       capita growth rates
#                   R - The variance-covariance matrix of the multivariate
#                       normally distributed process error with mean vector 0
#                   U_mean - A vector with mean of environmental variables                              
#                   U_cov - The variance-covariance matrix of environmental variables
#                   F_mean - A vector with mean of fishing mortalities     
#                   aic - Akaikes information criteria for the most parsimonious model
#                   struct - A logical matrix containing the final model structure
#
# @ Torbjörn Säterberg 181108
# 

#-----------------#
# model selection #
#-----------------#
model_selection <- function(DAT,Restrictions){
  
  # Initialize parameters  
  S <- dim(DAT$X)[2]
  nb_cov <- dim(DAT$U)[2]
  Res <- Restrictions==1
  opt_mod <- list()
  opt_mod$aicc <- Inf
  
  # If only one specific parameter set
  if(sum(Restrictions==0.5)==0){
    aicc <- Inf
    Res_temp <- Res
    n_par <- sum(Res_temp)+(S*(S+1))/2
    v <- (S*(S+1))/2 # number of parameters used to estimate covariance
    
    # Fit model
    fit <- VARX(DAT$X,1,cbind(DAT$F,DAT$U),0,fixed=t(Res_temp),output=F,
                include.mean=FALSE)
    
    # Calculate information criteria
    T <- dim(DAT$X)[1]
    sig = t(fit$residuals)%*%fit$residuals/(T-1) # sum of squared estimation residuals(mle see tsay 2014)
    d1 = log(det(sig))
    aic = T*d1 + 2*(n_par)
    aicc_temp <- aic+2*(n_par*(n_par+v))/(T*S-n_par-v) # Burnham & Andersson 2002 multivariate case eq. (7.91)
    
    if (aicc_temp < opt_mod$aicc){
        opt_mod <- fit
        opt_mod$aicc <- aicc_temp
      }
      else{
        opt_mod <- opt_mod
      }
    
    }else{
    
    params <- which(Restrictions==0.5) # possible interactions
    
    for(i in 1:length(params)){    
      comb <- combn(params,i) 
      for (j in 1:dim(comb)[2]){
        
        # decide which model to estimate
        Res_temp <- Res # fixed parameters
        Res_temp[comb[,j]] <- TRUE 
        n_par <- sum(Res_temp)+(S*(S+1))/2
        v <- (S*(S+1))/2 # number of parameters used to estimate covariance
        
        # Fit model
        capture.output(fit <- VARX(DAT$X,1,cbind(DAT$F,DAT$U),0,fixed=t(Res_temp),output=F,
                    include.mean=FALSE))
        
        # Calculate information criteria
        T <- dim(DAT$X)[1]
        sig = t(fit$residuals)%*%fit$residuals/(T-1) # sum of squared estimation residuals(mle see tsay 2014)
        d1 = log(det(sig))
        aic = T*d1 + 2*(n_par)
        aicc_temp <- aic+2*(n_par*(n_par+v))/(T*S-n_par-v) # Burnham & Andersson 2002 multivariate case eq. (7.91)
        if (aicc_temp < opt_mod$aicc){
            opt_mod <- fit
            opt_mod$aicc <- aicc_temp
          }
          else{
            opt_mod <- opt_mod
          }
        }
      }  
    }

    
    
    # check if model was fitted assuming no constant vector
    if(is.null(opt_mod$Ph0)){
      opt_mod$Ph0 <- matrix(0,S,1)
    }
    
    # Return parameter estimates for most parsimonous model
    F_mean <- colMeans(DAT$F)
    struct <- opt_mod$coef!=0 # optimal model structure
    param <- list(opt_mod$Ph0,opt_mod$Phi,opt_mod$beta[,(S+1):(S+nb_cov)],
                       opt_mod$beta[,1:S],opt_mod$Sigma,opt_mod$residuals,
                       DAT$X,DAT$U,DAT$U_mean,DAT$U_cov,DAT$F,F_mean,opt_mod$aicc,struct,
                       DAT$mean_ln,DAT$mean_survey)
    names(param) <- c("A","B","C","D","R","Res","X","U",
                           "U_mean","U_cov","F","F_mean","aicc",
                           "struct","mean_ln","mean_survey")
  return(param)
}

